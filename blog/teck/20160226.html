<!DOCTYPE html>
<html>
<head lang="ja">
<META http-equiv="Content-Type" content="text/html; charset=utf8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
<meta name="description" content="成り立ちの第二弾です。そうは言ってもソースが全公開されているので「ソース読んでくれれば良いよ」と言ってしまえばそれまでなんですが・・・"/>
<meta name="keywords" content="ご挨拶,エンジニア,ゆとり"/>
<meta name="createdate" content="2016-02-26"/>
<meta property="og:locale" content="ja_JP" />
<meta property="og:type" content="article" />
<meta property="og:title" content="ブログの成り立ち（2）｜ぬるぶろ" />
<meta property="og:description" content="成り立ちの第二弾です。そうは言ってもソースが全公開されているので「ソース読んでくれれば良いよ」と言ってしまえばそれまでなんですが・・・" />
<meta property="og:site_name" content="ぬるぶろ" />
<meta property="article:author" content="https://github.com/nullblog/" />
<meta property="fb:app_id" content="668279799978855" />
<title>ブログの成り立ち（2）｜ぬるぶろ</title>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/common.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/vue/1.0.16/vue.min.js"></script>
</head>
<body>
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NWH746"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NWH746');</script>
<!-- End Google Tag Manager -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5&appId=668279799978855";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>
<script>
(function() {
  var cx = '016288219579585099976:kl3aw8lrnoo';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//cse.google.com/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
</script>
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">ぬるぶろ</a>
    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li><a href="/">ホーム</a></li>
        <li class="active"><a href="/blog/">ブログ</a></li>
      </ul>
    </div>
  </div>
</div>
<div class="container-fluid">
  <div class="row">
    <div class="col-xs-12 text-center">
      <div class="row">
        <h1 class='col-md-6 col-md-offset-3'>ぬるぶろ</h1>
        <small class='col-md-3 text-right'>更新日:2016-02-26</small>
      </div>
    </div>
    <div id="col-left" class="col-md-3 col-left text-center">
      <div class="row">
        <div class="col-xs-12">
          <gcse:search></gcse:search>
        </div>
        <div class="col-xs-12">
          <div class="fb-like" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div>
          <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
          <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        </div>
      </div>
    </div>
    <div id='col-center' class="col-md-6 col-center">
<link href="http://alexgorbatchev.com/pub/sh/current/styles/shCoreDefault.css" rel="stylesheet" type="text/css">
<link href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" rel="stylesheet" type="text/css">
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js" type="text/javascript"></script>
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushPhp.js" type="text/javascript"></script>
<script type="text/javascript">
SyntaxHighlighter.all();
SyntaxHighlighter.defaults['toolbar'] = false;
</script>
<style>
.syntaxhighlighter {
  border:solid 1px #EEE !important;
  overflow-y: hidden !important;
}
.syntaxhighlighter table {
  margin-top: 1em !important;
  margin-bottom: 1em !important;
}
.syntaxhighlighter .line.alt2 {
  background-color: #F8F8F8 !important;
}
</style>
<div class="row">
  <div class="col-xs-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title text-center">ブログの成り立ち（2）</h3>
      </div>
      <div class="panel-body">
      <p><strong>ブログ一覧の表示って結構やばいよね</strong></p>
      <p>成り立ちの第二弾です。</p>
      <p>そうは言ってもソースが全公開されているので</p>
      <p>「ソース読んでくれれば良いよ」</p>
      <p>と言ってしまえばそれまでなんですが・・・</p>
      <br><br>
      <p>前の記事で生成したhtmlのコードをクローリングして</p>
      <p>中のmetaタグ等からjsonデータを生成します</p>
      <p>その生成したjsonデータをajaxで取得して</p>
      <p>htmlとして書き出す</p>
      <p>みたいなのがざっくりした流れです</p>
      <br><br>
      <p>まずはhtmlの解析ですが</p>
      <p>ざっくりと以下のような感じですね</p>
<pre class='brush: php'>/**
 * ブログの読み込み
 * @param string $dirName
 * @param string $fileName
 * @return array
 */
function readBlog($dirName, $fileName) {
	$result = array();
	// fileを取得してくる
	$html = file_get_contents($dirName . DIRECTORY_SEPARATOR . $fileName);

	// DOMDocumentとして取得する
	$domDocument = new DOMDocument();

	// 読み込みを行う
	// @はエラー抑制の演算子
	@$domDocument->loadHTML($html);

	// xmlデータとして取得
	$xmlString = $domDocument->saveXML();
	$xmlObject = simplexml_load_string($xmlString);

	// 配列に変換
	$array = json_decode(json_encode($xmlObject), true);

	// 欲しいデータを取得
	$result['href'] = str_replace('..', '', $dirName . DIRECTORY_SEPARATOR . $fileName);
	$result['title'] = isset($array['head']['title']) ? $array['head']['title'] : '';
	$result['blogtype'] = preg_replace('/^\.\.\/blog/', '', $dirName);

	// metaデータを回してほしい情報を取ってくる
	if($array['head']['meta']) {
		foreach($array['head']['meta'] as $meta) {
			if(isset($meta['@attributes']) && isset($meta['@attributes']['name']) && $meta['@attributes']['name'] == 'createdate') {
				$result['date'] = $meta['@attributes']['content'];
				break;
			}
		}
	}
	return $result;
}</pre>
      <p>超簡単ですね！ｗ</p>
      <p>後はjson_decodeで書き出せばおしまいです</p>
<pre class='brush: php'>/**
 * 書き出し
 */
function write() {
	// 順番の入れ替え
	usort(
		$this->result,
		function($a, $b){
			$a_time = strtotime($a['date']);
			$b_time = strtotime($b['date']);
			if($a_time === $b_time) {
				return 0;
			}
			return ($a_time < $b_time)? 1: -1;
		});
	file_put_contents(self::BLOG_PATH . DIRECTORY_SEPARATOR . 'index.json', json_encode($this->result));
}</pre>
      <p>fileの取得順で配列データが作られてしまうので</p>
      <p>書き出しの直前に日付順でsortをしています</p>
      <br><br>
      <p>あとはblogを取得して生成する側ですね</p>
      <p>これは<a href='http://nullblog.github.io/js/makelist.js' target='_blank'>makelist.js</a>というのを作って対応しています。</p>
      <p>jQueryとvue.jsを使って対応しています</p>
      <p>jQueryにしてもvueにしても</p>
      <p>ググったらいくらでも使い方が出てくるので</p>
      <p>まあここには書かなくても良いかなと・・・</p>
      <p>サンプルプログラムとしてお使い下さいな</p>
      </div>
    </div>
  </div>
</div>
    </div>
    <div id="col-right" class="col-md-3 col-right">
      <div class="panel-heading">
        <h3 class="panel-title text-center">ブログ一覧</h3>
      </div>
      <div class="panel-body">
        <label for="blog-search">絞り込みform</label>
        <select id="blog-search" class="form-control">
          <option v-for="list in blogLists" value="{{ list.path }}">{{ list.genre }}</option>
        </select>
      </div>

      <table id="blog-histry" class="table table-striped">
        <tr v-for="list in blogLists">
          <td><a href="{{ list.href }}"><strong>{{ list.title }}</strong></a></td>
          <td><a href="{{ list.href }}"><small>{{ list.blogtype }}</small></a></td>
          <td><a href="{{ list.href }}"><small>{{ list.date }}</small></a></td>
        </tr>
      </table>
    </div>
  </div>
</div>
<script src="/js/makelist.js"></script>
</body>
</html>
